================================================================================
BATCH 3 — AUTHENTICATION & SECURITY
Wall Street Fantasy League MVP — Anti-Cheat & Integrity Checklist
================================================================================

1. DUPLICATE ACCOUNT PREVENTION
-------------------------------

1.1 Detection Mechanisms
------------------------
CHECK-1.1.1: Email uniqueness
  - Firebase Auth enforces unique emails
  - Prevents same email registering twice
  - Social logins linked to same email merge accounts

CHECK-1.1.2: Device fingerprinting (future enhancement)
  - Collect device identifiers on signup
  - Flag accounts from same device
  - Not blocking, but logged for review

CHECK-1.1.3: IP address logging
  - Log IP on account creation
  - Flag multiple accounts from same IP in short window
  - Consider: shared IPs (offices, universities)

CHECK-1.1.4: Behavioral analysis (future enhancement)
  - Similar portfolio compositions
  - Coordinated join/submission patterns
  - Same match participation patterns

1.2 Enforcement Actions
-----------------------
ACTION-1.2.1: Automated flagging
  - Flag accounts meeting suspicion criteria
  - Do not auto-ban (false positives risk)
  - Queue for manual review

ACTION-1.2.2: Manual review process
  - Review flagged accounts weekly
  - Check for definitive duplicate indicators
  - Contact user if uncertain

ACTION-1.2.3: Duplicate confirmation
  - If confirmed duplicate:
    - Disable newer account
    - Preserve older account
    - Disqualify from affected matches
    - Update audit log

2. ONE PORTFOLIO PER USER PER MATCH
-----------------------------------

2.1 Enforcement Points
----------------------
CHECK-2.1.1: Database constraint
  - Portfolio document ID: composite of matchId + userId
  - Firestore will reject duplicate document IDs
  - Provides atomic uniqueness guarantee

CHECK-2.1.2: Security rules check
  - Before portfolio create, verify no existing portfolio
  - Query: portfolios where matchId == X and userId == Y
  - Deny if result count > 0

CHECK-2.1.3: Cloud Function validation
  - Double-check in submitPortfolio function
  - Transaction ensures atomicity
  - Log attempts to create duplicate

2.2 Edge Cases
--------------
EDGE-2.2.1: Race condition on submit
  - User submits twice rapidly
  - First write wins (Firestore transaction)
  - Second write fails gracefully
  - Return existing portfolio to client

EDGE-2.2.2: Portfolio update vs. create
  - Before lock: updates replace previous
  - After lock: all writes rejected
  - isLocked flag is source of truth

3. EXCESSIVE MATCH CREATION LIMITS
----------------------------------

3.1 Limits
----------
LIMIT-3.1.1: Active created matches
  - Maximum 5 active matches created per user
  - Active = DRAFT, OPEN, LIVE, SETTLING states
  - FINISHED and CANCELLED don't count

LIMIT-3.1.2: Daily creation rate
  - Maximum 10 matches created per day
  - Resets at midnight UTC
  - Prevents spam/abuse

LIMIT-3.1.3: Concurrent participation
  - No limit on matches joined (MVP)
  - Future: may limit to prevent spreading too thin

3.2 Enforcement
---------------
CHECK-3.2.1: Pre-creation query
  - Count user's active created matches
  - Reject if >= 5

CHECK-3.2.2: Rate limit tracking
  - Track in user document: dailyMatchCreations, lastCreationDate
  - Reset counter if date changed
  - Increment on each creation

4. PRICE DATA INTEGRITY
-----------------------

4.1 Data Source Validation
--------------------------
CHECK-4.1.1: Source authentication
  - API calls use authenticated credentials
  - Credentials stored in Firebase secrets
  - Rotate keys periodically

CHECK-4.1.2: Response validation
  - Validate response schema
  - Check for reasonable price ranges
  - Flag anomalies (>50% daily change)

CHECK-4.1.3: Timestamp verification
  - Price timestamp within expected window
  - Reject stale data (>24 hours old)
  - Log and alert on anomalies

4.2 Storage Integrity
---------------------
CHECK-4.2.1: Write-once enforcement
  - Price snapshots are immutable
  - Security rules prevent updates
  - Only system can create

CHECK-4.2.2: Audit trail
  - Log all price writes to auditLog
  - Include source, timestamp, requestor
  - Enable forensic analysis

4.3 Settlement Integrity
------------------------
CHECK-4.3.1: Deterministic calculation
  - Same inputs always produce same outputs
  - No randomness in settlement
  - Reproducible for auditing

CHECK-4.3.2: Idempotent settlement
  - Running settlement twice produces same result
  - Prevents double-counting
  - Safe to retry on failure

CHECK-4.3.3: Price locking
  - Prices locked at settlement start
  - No price changes affect in-progress settlement
  - Use transaction isolation

5. SUSPICIOUS ACTIVITY INDICATORS
---------------------------------

5.1 Account-Level Indicators
----------------------------
INDICATOR-5.1.1: Rapid account creation
  - Multiple accounts from same IP in 24 hours
  - Severity: MEDIUM
  - Action: Flag for review

INDICATOR-5.1.2: Unverified email activity
  - Attempting actions without verification
  - Severity: LOW
  - Action: Block action, prompt verification

INDICATOR-5.1.3: Unusual login patterns
  - Logins from multiple countries in short time
  - Severity: HIGH
  - Action: Force re-authentication, notify user

5.2 Match-Level Indicators
--------------------------
INDICATOR-5.2.1: Mass match creation
  - Creating matches rapidly then abandoning
  - Severity: MEDIUM
  - Action: Reduce creation limit, flag

INDICATOR-5.2.2: Match code sharing
  - Private match code appears in multiple joins rapidly
  - Severity: LOW (could be legitimate sharing)
  - Action: Monitor, no immediate action

INDICATOR-5.2.3: Creator always wins
  - Match creator consistently ranks #1
  - Severity: MEDIUM (statistical anomaly)
  - Action: Flag for review after N occurrences

5.3 Portfolio-Level Indicators
------------------------------
INDICATOR-5.3.1: Identical portfolios
  - Multiple users submit exact same portfolio
  - Severity: HIGH (collusion indicator)
  - Action: Flag users and match

INDICATOR-5.3.2: Last-second submission spike
  - Unusually high submissions in final minute
  - Severity: LOW (could be procrastination)
  - Action: Monitor for patterns

INDICATOR-5.3.3: Impossible allocation
  - Allocation doesn't sum to $10,000
  - Severity: CRITICAL (system bug or attack)
  - Action: Reject, alert engineering

6. RATE LIMITING IMPLEMENTATION
-------------------------------

6.1 API Endpoint Limits
-----------------------
Endpoint                  | Rate Limit        | Window    | Response
--------------------------|-------------------|-----------|------------------
POST /matches             | 10                | 24 hours  | 429 Too Many
POST /portfolios          | 20                | 1 hour    | 429 Too Many
GET /matches              | 100               | 1 minute  | 429 Too Many
GET /leaderboard          | 60                | 1 minute  | 429 Too Many
GET /symbols/search       | 30                | 1 minute  | 429 Too Many

6.2 Implementation Strategy
---------------------------
STRATEGY-6.2.1: Firebase App Check
  - Enable App Check for mobile/web
  - Attests app authenticity
  - Prevents API abuse from unauthorized clients

STRATEGY-6.2.2: Cloud Functions rate limiting
  - Use Firebase Extensions or custom middleware
  - Track requests per UID per endpoint
  - Store counts in Firestore or Redis

STRATEGY-6.2.3: Graceful degradation
  - Return 429 with Retry-After header
  - Exponential backoff suggested to client
  - Don't block indefinitely

7. FUTURE KYC CONSIDERATIONS
----------------------------

Not implemented in MVP, but designed for future:

7.1 KYC Triggers (Future)
-------------------------
- Real money features (if ever added)
- Prize redemption
- Suspicious activity threshold exceeded
- Regulatory requirement

7.2 KYC Data (Future)
---------------------
- Legal name
- Date of birth
- Address
- Government ID verification
- Third-party verification service

7.3 MVP Preparation
-------------------
PREP-7.3.1: User schema includes:
  - Placeholder for kycStatus field
  - Placeholder for kycVerifiedAt field
  - No actual KYC collection in MVP

PREP-7.3.2: Terms of Service includes:
  - Clause about future verification requirements
  - Right to request identity verification
  - Account suspension for non-compliance

8. INTEGRITY MONITORING DASHBOARD (MVP Scope)
---------------------------------------------

8.1 Metrics to Track
--------------------
METRIC-8.1.1: Daily signups by method
METRIC-8.1.2: Failed login attempts (rate)
METRIC-8.1.3: Portfolio submission failures (rate)
METRIC-8.1.4: Flagged accounts count
METRIC-8.1.5: Price fetch success rate
METRIC-8.1.6: Settlement completion time

8.2 Alerts to Configure
-----------------------
ALERT-8.2.1: Price API failure (immediate)
ALERT-8.2.2: Settlement failure (immediate)
ALERT-8.2.3: Unusual signup spike (threshold)
ALERT-8.2.4: Multiple failed settlements (threshold)

9. INTEGRITY CHECKLIST SUMMARY
------------------------------

Category               | Check ID       | MVP Status | Automated
-----------------------|----------------|------------|----------
Duplicate accounts     | CHECK-1.1.1    | Yes        | Yes
                       | CHECK-1.1.2    | No         | -
                       | CHECK-1.1.3    | Yes        | Partial
                       | CHECK-1.1.4    | No         | -
One portfolio/match    | CHECK-2.1.1    | Yes        | Yes
                       | CHECK-2.1.2    | Yes        | Yes
                       | CHECK-2.1.3    | Yes        | Yes
Match creation limits  | CHECK-3.2.1    | Yes        | Yes
                       | CHECK-3.2.2    | Yes        | Yes
Price integrity        | CHECK-4.1.1    | Yes        | Yes
                       | CHECK-4.1.2    | Yes        | Yes
                       | CHECK-4.1.3    | Yes        | Yes
                       | CHECK-4.2.1    | Yes        | Yes
                       | CHECK-4.3.1    | Yes        | Yes
                       | CHECK-4.3.2    | Yes        | Yes
Suspicious activity    | INDICATOR-5.1.1| Yes        | Partial
                       | INDICATOR-5.3.1| Yes        | Yes
Rate limiting          | STRATEGY-6.2.1 | Yes        | Yes
                       | STRATEGY-6.2.2 | Yes        | Yes

================================================================================
END OF ANTI-CHEAT & INTEGRITY CHECKLIST
================================================================================
